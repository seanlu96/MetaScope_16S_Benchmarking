---
title: "botero_analysis"
author: "Sean Lu"
date: "`r Sys.Date()`"
output: pdf_document
editor_options:
  chunk_output_type: console
---
```{r knitr options, include = FALSE}
knitr::opts_chunk$set(cache=FALSE, cache.path=".cache/")
```

## Setup
```{r Loading in Libraries}
library("phyloseq")
library("ggplot2")     
library("dplyr")        
library("tibble")
library("ggpubr")
library("phylosmith")
library("DESeq2")
library("EnhancedVolcano")
library("SpiecEasi")
```


## Load in processed Data
```{r, eval=TRUE, include=TRUE}
ps_dada2 <- readRDS("data_processed/botero_2014/ps_dada2.rds")
ps_ms <- readRDS("data_processed/botero_2014/ps_metascope_priors_trimmed.rds")

ps_dada2_oral <- subset_samples(ps_dada2, Sample_type == "Oropharynx")
ps_ms_oral <- subset_samples(ps_ms, Sample_type == "Oropharynx")
ps_dada2_nasal <- subset_samples(ps_dada2, Sample_type == "Nasal")
ps_ms_nasal <- subset_samples(ps_ms, Sample_type == "Nasal")
```
The DADA2 data is generated from the `dada2_botero.Rmd` file. The MetaScope data 
was generated from the `process_metascope_id.R` functions. 

## Plotting relative abundances of MetaScope and DADA2
### Species Level Abundances
```{r Species Level Abundances}
dada2_df <- psmelt(ps_dada2) |> 
  dplyr::mutate(Species = ifelse(is.na(Species), NA, paste0(Genus, " ", Species)))
dada2_df$pipeline = "DADA2"

ms_df <- psmelt(ps_ms)
ms_df$pipeline = "MetaScope"
ms_df$kingdom = "Bacteria"
ms_df <- ms_df |>
  dplyr::relocate(kingdom, .before = phylum)
colnames(ms_df) <- c("OTU", "Sample", "Abundance", "Sequencing_Type", "Patient",
                     "Sample_type", "status", "Kingdom", "Phylum", "Class", 
                     "Order", "Family", "Genus", "Species", "pipeline")

merged_df <- rbind(dada2_df, ms_df)

relab_species <- ggplot(merged_df, aes(x = Sample, y = Abundance, fill = Species)) + 
  geom_bar(position ="fill",stat = "identity") + 
  facet_grid(cols = c(vars(Sample_type), vars(status), vars(pipeline)), scales = "free_x")
relab_species + 
  theme(legend.position = "none",
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())
relab_species_legend <- get_legend(relab_species)
as_ggplot(relab_species_legend)

```

```{r Saving stacked species relab figures, eval=FALSE, include=FALSE}
ggsave(file="figures/p1_stacked_relab.svg", 
       plot=relab_species + theme(legend.position = "none",
           axis.text.x=element_blank(),
           axis.ticks.x=element_blank()),
       device = "svg", width=7.5, height=4, units="in",
       dpi = 300)

ggsave(file="figures/p1_legend.svg", plot=as_ggplot(relab_species_legend),
       device = "svg", width=7.5, height=4, units="in",
       dpi = 300)
```

### Genus Level Abundances
```{r, Genus level Abundances}
relab_genus <- ggplot(merged_df, aes(x = Sample, y = Abundance, fill = Genus)) + 
  geom_bar(position ="fill",stat = "identity") + 
  facet_grid(cols = c(vars(Sample_type), vars(status), vars(pipeline)), scales = "free_x")
relab_genus + 
  theme(legend.position = "none",
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())
relab_genus_legend <- get_legend(relab_genus)
as_ggplot(relab_genus_legend)
```

```{r Saving stacked genus relab figures, eval=FALSE, include=FALSE}
ggsave(file="figures/p2_stacked_relab_genus.svg", 
       plot=relab_genus + theme(legend.position = "none",
           axis.text.x=element_blank(),
           axis.ticks.x=element_blank()),
       device = "svg", width=7.5, height=4, units="in",
       dpi = 300)
ggsave(file="figures/p2_legend.svg", plot=as_ggplot(relab_genus_legend),
       device = "svg", width=7.5, height=4, units="in",
       dpi = 300)
```

### Phylum Level Abundances
```{r, Phylum level Abundances}
relab_phylum <- ggplot(merged_df, aes(x = Sample, y = Abundance, fill = Phylum)) + 
  geom_bar(position ="fill",stat = "identity") + 
  facet_grid(cols = c(vars(Sample_type), vars(status), vars(pipeline)), scales = "free_x")
relab_phylum + 
  theme(legend.position = "none",
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())
relab_phylum_legend <- get_legend(relab_phylum)
as_ggplot(relab_phylum_legend)
```

```{r Saving stacked phylum relab figures, eval=FALSE, include=FALSE}
ggsave(file="figures/p3_stacked_relab_phylum.svg", 
       plot=relab_genus + theme(legend.position = "none",
           axis.text.x=element_blank(),
           axis.ticks.x=element_blank()),
       device = "svg", width=7.5, height=4, units="in",
       dpi = 300)
ggsave(file="figures/p3_legend.svg", plot=as_ggplot(relab_phylum_legend),
       device = "svg", width=7.5, height=4, units="in",
       dpi = 300)
```

## Filtered abundance barplots
```{r Filtered abundance plots}
high_abund_dada2 <- merged_df |> 
  dplyr::filter(Abundance > 1000) |>
  dplyr::filter(pipeline == "DADA2")

high_abund_ms <- merged_df |> 
  dplyr::filter(Abundance > 1000) |>
  dplyr::filter(pipeline == "MetaScope")

select_species_both <- unique(high_abund_dada2$Species[high_abund_dada2$Species %in% high_abund_ms$Species])
select_species_dada2 <- unique(high_abund_dada2$Species[!(high_abund_dada2$Species %in% high_abund_ms$Species)])
select_species_ms <- unique(high_abund_ms$Species[!(high_abund_ms$Species %in% high_abund_dada2$Species)])

ms_unique_species <- merged_df |> 
  dplyr::filter(Species %in% select_species_ms) |>
  ggplot(aes(fill=Sample_type, y=Abundance, x=Species)) + 
  geom_bar(position="dodge", stat="identity") + 
  facet_grid(vars(pipeline), vars(status)) + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
ms_unique_species
  
dada2_unique_species <- merged_df |> 
  dplyr::filter(Species %in% select_species_dada2) |>
  ggplot(aes(fill=Sample_type, y=Abundance, x=Species)) + 
  geom_bar(position="dodge", stat="identity") + 
  facet_grid(vars(pipeline), vars(status)) + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
dada2_unique_species

high_abund_species <- merged_df |> 
  dplyr::filter(Species %in% select_species_both) |>
  ggplot(aes(fill=Sample_type, y=Abundance, x=Species)) + 
  geom_bar(position="dodge", stat="identity") + 
  facet_grid(vars(pipeline), vars(status)) + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
high_abund_species
```

```{r Saving high abundance plots, eval=FALSE, include=FALSE}
ggsave(file="figures/p4_ms_unique_species.svg", plot=ms_unique_species,
       device = "svg", width=7.5, height=4, units="in",
       dpi = 300)

ggsave(file="figures/p5_dada2_unique_species.svg", plot=dada2_unique_species,
       device = "svg", width=7.5, height=4, units="in",
       dpi = 300)

ggsave(file="figures/p6_high_abund_species", plot=high_abund_species,
       device = "svg", width=7.5, height=4, units="in",
       dpi = 300)
```

## Heatmaps
```{r Filtered heatmaps}
ps_ms_filt <- taxa_filter(ps_ms, frequency = 0.05)
  
abundance_heatmap(ps_ms_filt, classification = 'genus',
  treatment = "Sample_type", transformation = 'log10') + 
  facet_wrap(vars(status,Sample_type), nrow = 1, scales = "free_x")

ps_dada2_filt <- taxa_filter(ps_dada2, frequency = 0.01)
abundance_heatmap(ps_dada2_filt, classification = 'Genus',
  treatment = "Sample_type", transformation = 'log2') + 
  facet_wrap(vars(status,Sample_type), nrow = 1, scales = "free_x")
```

## Plotting Alpha Diversity
```{r Alpha Diversity}
p2_1 <- plot_richness(ps_dada2_oral, measures=c("Observed", "Chao1", "ACE", "Shannon", "Simpson", "InvSimpson", "Fisher"), x = "status") + 
  stat_compare_means(label = "p.signif", label.x = 1.5, comparisons = list(c("Control", "TB"))) + 
  geom_boxplot()

p2_2 <- plot_richness(ps_ms_oral, measures=c("Observed", "Chao1", "ACE", "Shannon", "Simpson", "InvSimpson", "Fisher"), x = "status") + 
  stat_compare_means(label = "p.signif", label.x = 1.5, comparisons = list(c("Control", "TB"))) + 
  geom_boxplot()

p2_3 <- plot_richness(ps_dada2_nasal, measures=c("Observed", "Chao1", "ACE", "Shannon", "Simpson", "InvSimpson", "Fisher"), x = "status") + 
  stat_compare_means(label = "p.signif", label.x = 1.5, comparisons = list(c("Control", "TB"))) + 
  geom_boxplot()

p2_4 <- plot_richness(ps_ms_nasal, measures=c("Observed", "Chao1", "ACE", "Shannon", "Simpson", "InvSimpson", "Fisher"), x = "status") + 
  stat_compare_means(label = "p.signif", label.x = 1.5, comparisons = list(c("Control", "TB"))) + 
  geom_boxplot()


```

## PCOA Plots
```{r PCoA plots}
ps_ms.ord <- ordinate(ps_ms, "PCoA", "bray")
plot_ordination(ps_ms, ps_ms.ord, type="samples", color="status", shape="Sample_type", title="Samples") + 
  geom_point(size=3) + 
  stat_ellipse(
    aes(linetype=Sample_type))

ps_dada2.ord <- ordinate(ps_dada2, "PCoA", "bray")
plot_ordination(ps_dada2, ps_dada2.ord, type="samples", color="status", shape="Sample_type", title="Samples") + 
  geom_point(size=3) + 
  stat_ellipse(
    aes(linetype=Sample_type))

```

```{r}
taxa_core_graph(ps_ms, treatment = NULL, subset = NULL, 
  frequencies = seq(0.1, 1, 0.1), abundance_thresholds = seq(0.01, 1, 0.01), 
  colors = 'default')

taxa_core_graph(ps_dada2, treatment = NULL, subset = NULL, 
  frequencies = seq(0.1, 1, 0.1), abundance_thresholds = seq(0.01, 1, 0.01), 
  colors = 'default')
```

```{r}
deseq_ms_oral = phyloseq_to_deseq2(ps_ms_oral, ~ status)
deseq_ms_oral = estimateSizeFactors(deseq_ms_oral, type = 'poscounts')
deseq_ms_oral = DESeq(deseq_ms_oral, test="Wald", fitType="parametric")
deseq_ms_oral_res = results(deseq_ms_oral, cooksCutoff = FALSE)
deseq_ms_oral_res <- cbind(deseq_ms_oral_res, 
                           as(tax_table(ps_ms_oral)[rownames(deseq_ms_oral_res), ], "matrix"))

EnhancedVolcano(deseq_ms_oral_res,
  lab = deseq_ms_oral_res$species,
  x = 'log2FoldChange',
  y = 'pvalue')

deseq_ms_nasal = phyloseq_to_deseq2(ps_ms_nasal, ~ status)
deseq_ms_nasal = estimateSizeFactors(deseq_ms_nasal, type = 'poscounts')
deseq_ms_nasal = DESeq(deseq_ms_nasal, test="Wald", fitType="parametric")
deseq_ms_nasal_res = results(deseq_ms_nasal, cooksCutoff = FALSE)
deseq_ms_nasal_res <- cbind(deseq_ms_nasal_res, 
                           as(tax_table(ps_ms_nasal)[rownames(deseq_ms_nasal_res), ], "matrix"))

EnhancedVolcano(deseq_ms_nasal_res,
  lab = deseq_ms_nasal_res$species,
  x = 'log2FoldChange',
  y = 'pvalue')


deseq_dada2_oral = phyloseq_to_deseq2(ps_dada2_oral, ~ status)
deseq_dada2_oral = estimateSizeFactors(deseq_dada2_oral, type = 'poscounts')
deseq_dada2_oral = DESeq(deseq_dada2_oral, test="Wald", fitType="parametric")

deseq_dada2_oral_res = results(deseq_dada2_oral, cooksCutoff = FALSE)
deseq_dada2_oral_res <- cbind(deseq_dada2_oral_res, 
                              as(tax_table(ps_dada2_oral)[rownames(deseq_dada2_oral_res), ], "matrix"))
EnhancedVolcano(deseq_dada2_oral_res,
  lab = paste0(deseq_dada2_oral_res$Genus, " ", deseq_dada2_oral_res$Species),
  x = 'log2FoldChange',
  y = 'pvalue')

deseq_dada2_nasal = phyloseq_to_deseq2(ps_dada2_nasal, ~ status)
deseq_dada2_nasal = estimateSizeFactors(deseq_dada2_nasal, type = 'poscounts')
deseq_dada2_nasal = DESeq(deseq_dada2_nasal, test="Wald", fitType="parametric")

deseq_dada2_nasal_res = results(deseq_dada2_nasal, cooksCutoff = FALSE)
deseq_dada2_nasal_res <- cbind(deseq_dada2_nasal_res, 
                              as(tax_table(ps_dada2_nasal)[rownames(deseq_dada2_nasal_res), ], "matrix"))
EnhancedVolcano(deseq_dada2_nasal_res,
  lab = paste0(deseq_dada2_nasal_res$Genus, " ", deseq_dada2_nasal_res$Species),
  x = 'log2FoldChange',
  y = 'pvalue')

```

## Network Analysis
```{r}
pargs <- list(rep.num=50, seed=10010, ncores=4)
se_ms <- spiec.easi(ps_dada2, method='mb', lambda.min.ratio=1e-2,
                    sel.criterion='bstars', pulsar.select=TRUE,
                    nlambda=20, pulsar.params=pargs)
ig2.mb <- adj2igraph(getRefit(se.mb.amgut2),  vertex.attr=list(name=taxa_names(amgut2.filt.phy)))
plot_network(ig2.mb, amgut2.filt.phy, type='taxa', color="Rank3")
```